<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Flash Player</title>
    <!-- 使用固定版本Ruffle，避免最新版不兼容 -->
    <script src="https://cdn.jsdelivr.net/npm/@ruffle-rs/ruffle@2024.10.14"></script>
</head>
<body>
    <div id="status">状态：等待Ruffle就绪...</div>
    <!-- 游戏播放器 -->
    <ruffle-player id="gamePlayer" width="800" height="600">
        <a href="d1.swf"></a>
    </ruffle-player>

    <script>
        const statusEl = document.getElementById('status');
        const playerEl = document.getElementById('gamePlayer');
        let checkAttempts = 0;
        const maxAttempts = 10; // 最多尝试10次

        // 核心：主动检查并尝试初始化Ruffle播放器
        function tryInitializeRuffle() {
            checkAttempts++;
            
            // 关键检查1: Ruffle全局对象是否存在
            if (!window.RufflePlayer) {
                statusEl.textContent = `状态：尝试中 (${checkAttempts}/10) - 等待Ruffle库...`;
                if (checkAttempts < maxAttempts) {
                    setTimeout(tryInitializeRuffle, 500);
                } else {
                    statusEl.textContent = '状态：❌ 失败 - Ruffle库未加载。请检查网络或CDN。';
                    statusEl.style.color = 'red';
                }
                return;
            }

            // 关键检查2: Ruffle是否已接管播放器元素（通过shadowRoot判断）
            if (playerEl.shadowRoot) {
                statusEl.textContent = '状态：✅ 成功 - Ruffle播放器已激活！';
                statusEl.style.color = 'green';
                console.log('✅ Ruffle初始化成功。');
                return;
            }

            // 如果库已加载但未接管，尝试调用Ruffle的初始化方法
            if (window.RufflePlayer && window.RufflePlayer.config) {
                try {
                    // 尝试手动初始化所有ruffle-player元素
                    window.RufflePlayer = window.RufflePlayer || {};
                    window.RufflePlayer.config = {
                        "publicPath": "https://cdn.jsdelivr.net/npm/@ruffle-rs/ruffle@2024.10.14/",
                        "polyfills": true // 启用兼容性垫片
                    };
                    
                    // 重要：触发Ruffle重新扫描并初始化播放器
                    if (window.RufflePlayer.load) {
                        window.RufflePlayer.load();
                    }
                } catch (e) {
                    console.warn('手动初始化尝试失败:', e);
                }
            }

            // 继续检查，直到达到最大尝试次数
            if (checkAttempts < maxAttempts) {
                statusEl.textContent = `状态：尝试中 (${checkAttempts}/10) - 正在初始化引擎...`;
                setTimeout(tryInitializeRuffle, 500);
            } else {
                statusEl.textContent = '状态：❌ 失败 - Ruffle引擎无法启动。请更换浏览器或设备测试。';
                statusEl.style.color = 'red';
                console.error('❌ Ruffle初始化最终失败。此环境可能不兼容。');
            }
        }

        // 页面加载后开始初始化尝试
        window.addEventListener('DOMContentLoaded', () => {
            setTimeout(tryInitializeRuffle, 100);
        });
    </script>
</body>
</html>
